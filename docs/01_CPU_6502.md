# MOS Technology 6502 Processor

## Overview
The **MOS 6502** is an 8-bit microprocessor that became ubiquitous in the late 1970s and 1980s, powering legendary machines like the Apple II, Commodore 64, NES, and Atari 2600 (as the 6507 variant). 

For an emulator, understanding the 6502 requires accurate modeling of its **cycles**, **bus operations**, and **quirks** (like the page boundary crossing penalty and decimal mode behavior).

## 1. Architecture & Registers

The 6502 is little-endian (least significant byte first). It has a 16-bit address bus (64KB memory space) and an 8-bit data bus.

### Registers
| Register | Name | Size | Description |
| :--- | :--- | :--- | :--- |
| **A** | Accumulator | 8-bit | Primary register for arithmetic and logic operations. |
| **X** | Index Register X | 8-bit | Used for indexed addressing and counters. |
| **Y** | Index Register Y | 8-bit | Used for indexed addressing and counters. |
| **SP** | Stack Pointer | 8-bit | Points to the next free location on the stack (located at `$0100-$01FF`). The stack grows downwards (decrement push, increment pop). |
| **PC** | Program Counter | 16-bit | Points to the next instruction to execute. |
| **P** | Processor Status | 8-bit | Contains condition flags. |

### Processor Status (P) Flags
Layout: `N V - B D I Z C`

| Bit | Flag | Name | Function |
| :---: | :---: | :--- | :--- |
| 7 | **N** | Negative | Set if the result of an operation has bit 7 set (is negative). |
| 6 | **V** | Overflow | Set if an arithmetic operation overflows the signed 8-bit range (-128 to +127). |
| 5 | **-** | Unused | Always reads as logic 1 (sometimes ignored). |
| 4 | **B** | Break | Set when a `BRK` instruction is executed. Distinguishes software interrupts from hardware interrupts on the stack. |
| 3 | **D** | Decimal | If set, ADC and SBC operate in Binary Coded Decimal (BCD) mode. (Note: The Ricoh 2A03 in the NES ignores this flag). |
| 2 | **I** | Interrupt Disable | If set, Maskable Interrupts (IRQ) are disabled. Does not affect NMI. |
| 1 | **Z** | Zero | Set if the result of an operation is zero. |
| 0 | **C** | Carry | Holds the carry out of the MSB in additions, or the borrow in subtractions. Also used in shifts/rotates. |

---

## 2. Addressing Modes

The 6502 has a rich set of addressing modes, allowing efficient access to memory. Specifically, **Zero Page** modes are faster (3 cycles vs 4) because they assume the high byte of the address is `$00`.

| Mode | Syntax | Opcode Ex | Description |
| :--- | :--- | :--- | :--- |
| **Implicit** | `INX` | `E8` | Operand is implied by the instruction. |
| **Accumulator** | `ROR A` | `6A` | Operates directly on the Accumulator. |
| **Immediate** | `LDA #$10` | `A9` | Review the next byte as the value. |
| **Zero Page** | `LDA $10` | `A5` | Address is in `$00xx`. Uses 1 byte for address. |
| **Zero Page, X** | `LDA $10,X` | `B5` | Address is `$00xx + X`. Wraps around zero page (no carry to high byte). |
| **Zero Page, Y** | `LDX $10,Y` | `B6` | Address is `$00xx + Y`. Wraps around zero page. |
| **Absolute** | `LDA $1234` | `AD` | Full 16-bit address (Low byte first). |
| **Absolute, X** | `LDA $1234,X` | `BD` | Address is `$1234 + X`. (+1 cycle if page crossed). |
| **Absolute, Y** | `LDA $1234,Y` | `B9` | Address is `$1234 + Y`. (+1 cycle if page crossed). |
| **Indirect** | `JMP ($1234)` | `6C` | Jumps to address stored at `$1234`. (Has a hardware bug at page boundary!). |
| **Indirect, X** | `LDA ($10,X)` | `A1` | (Pre-indexed indirect). Calc zero page addr `$xx + X`, read 16-bit addr from there. |
| **Indirect, Y** | `LDA ($10),Y` | `B1` | (Post-indexed indirect). Read 16-bit addr from zero page `$xx`, then add Y. (+1 cycle if page crossed). |
| **Relative** | `BNE $05` | `D0` | Signed 8-bit offset from PC (for branches). |

### Important Emulation Details
*   **Page Crossing**: For `Absolute,X/Y` and `Indirect,Y`, if the addition of the index register changes the high byte of the address (e.g., `$10FF + 1 = $1100`), it consumes an extra CPU cycle. This is critical for accurate timing.
*   **Modify-Write**: Instructions like `INC`, `DEC`, `ASL` on memory perform a **Read-Modify-Write** cycle. They read the value, write the *original* value back (dummy write), modify it, and then write the *new* value. This can trigger side-effects in memory-mapped I/O registers twice.

---

## 3. Interrupts & Reset

The 6502 has 3 hardware vectors located at the top of memory:

| Vector | Address | Description |
| :--- | :--- | :--- |
| **NMI** | `$FFFA - $FFFB` | Non-Maskable Interrupt. Verified edge-sensitive. Cannot be masked by `I` flag. |
| **RESET** | `$FFFC - $FFFD` | CPU loads PC from this address on power-up. |
| **IRQ** | `$FFFE - $FFFF` | Interrupt Request. Level-sensitive. Masked by `I` flag. |

**Interrupt Sequence**:
1.  Finish current instruction.
2.  Push PC High, then PC Low to stack.
3.  Push Status Register (P) to stack (with Break flag **clear**).
4.  Set Interrupt Disable (I) flag.
5.  Load PC from Vector Address.

---

## 4. The 6507 Variant (Atari 2600)
The **6507** is a 6502 in a smaller package (28 pins vs 40 pins).
*   **Address Bus**: Only 13 lines (A0-A12). It can only address **8KB** (`$0000 - $1FFF`).
*   **Interrupts**: No NMI or IRQ pins connected.
*   **RDY**: The RDY line is used by the TIA to halt the CPU (used for synchronization, `WSYNC`).

**Implication**: For 2600 emulation, you must treat memory accesses above `$1FFF` as mirrors, typically wrapping every 8KB, but practically the system only sees the first 8KB. However, cartridge mappers often bankswitch within the `$1000-$1FFF` region.
